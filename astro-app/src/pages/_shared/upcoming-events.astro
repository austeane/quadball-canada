---
import Layout from "@/layouts/Layout.astro";
import type { Locale } from "@/utils/localization";
import { getUpcomingEvents } from "@/utils/sanity";
import { formatDate } from "@/utils";

interface Props {
  locale: Locale;
}

const { locale } = Astro.props as Props;
const isFr = locale === "fr";

const events = await getUpcomingEvents(locale);

const content = isFr
  ? {
      layoutTitle: "Événements à venir — Quadball Canada",
      heading: "Événements à venir",
      intro: "Découvrez les tournois, camps et événements de quadball à venir partout au Canada.",
      noEvents: "Aucun événement à venir pour le moment. Revenez bientôt!",
      addToCalendar: "Ajouter au calendrier",
      details: "Voir les détails",
      virtual: "Virtuel",
      hybrid: "Hybride",
    }
  : {
      layoutTitle: "Upcoming Events — Quadball Canada",
      heading: "Upcoming Events",
      intro: "Find upcoming quadball tournaments, camps, and events across Canada.",
      noEvents: "No upcoming events at the moment. Check back soon!",
      addToCalendar: "Add to Calendar",
      details: "View Details",
      virtual: "Virtual",
      hybrid: "Hybrid",
    };

const alternate = {
  en: "/events/upcoming/",
  fr: "/fr/evenements/a-venir/",
};

const basePath = isFr ? "/fr/evenements/" : "/events/";

function formatEventDate(start: string, end?: string): string {
  const startDate = new Date(start);
  const endDate = end ? new Date(end) : null;

  if (endDate && end && startDate.toDateString() !== endDate.toDateString()) {
    return `${formatDate(start, locale)} — ${formatDate(end, locale)}`;
  }
  return formatDate(start, locale);
}
---

<Layout title={content.layoutTitle} alternate={alternate} locale={locale}>
  <section class="upcoming-events">
    <header class="header">
      <h1>{content.heading}</h1>
      <p class="intro">{content.intro}</p>
      <a class="calendar-btn" href="/events.ics">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        {content.addToCalendar} (ICS)
      </a>
    </header>

    {events.length === 0 ? (
      <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <p>{content.noEvents}</p>
      </div>
    ) : (
      <div class="events-grid">
        {events.map((event, index) => (
          <article class={`event-card ${index === 0 ? "event-card--featured" : ""}`}>
            <div class="event-card__date">
              <span class="event-card__month">{new Date(event.startDateTime).toLocaleDateString(isFr ? "fr-CA" : "en-CA", { month: "short" })}</span>
              <span class="event-card__day">{new Date(event.startDateTime).getDate()}</span>
            </div>
            <div class="event-card__content">
              <h2 class="event-card__title">
                <a href={`${basePath}${event.slug}`}>{event.title}</a>
              </h2>
              <p class="event-card__datetime">{formatEventDate(event.startDateTime, event.endDateTime)}</p>
              {event.location && (
                <p class="event-card__location">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  {event.location.type === "virtual" ? (
                    <span class="event-card__badge">{content.virtual}</span>
                  ) : event.location.type === "hybrid" ? (
                    <span class="event-card__badge">{content.hybrid}</span>
                  ) : null}
                  {event.location.name || event.location.address}
                </p>
              )}
              {event.description && (
                <p class="event-card__desc">{event.description.length > 150 ? event.description.slice(0, 150) + "..." : event.description}</p>
              )}
              <a class="event-card__link" href={`${basePath}${event.slug}`}>
                {content.details}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
              </a>
            </div>
          </article>
        ))}
      </div>
    )}
  </section>
</Layout>

<style>
  .upcoming-events {
    padding: 3rem 0;
  }

  .header {
    max-width: 720px;
    margin-bottom: 3rem;
  }

  .header h1 {
    margin-bottom: 0.75rem;
  }

  .intro {
    font-size: 1.125rem;
    color: var(--text-muted);
    margin-bottom: 1.5rem;
  }

  .calendar-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    background: var(--bg-secondary, #f8f9fa);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-strong);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
    transition: border-color 0.2s, color 0.2s;
  }

  .calendar-btn:hover {
    border-color: var(--brand-primary);
    color: var(--brand-primary);
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
    color: var(--text-muted);
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 12px;
  }

  .empty-state svg {
    margin-bottom: 1rem;
    opacity: 0.4;
  }

  .events-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .event-card {
    display: flex;
    gap: 1.5rem;
    padding: 1.5rem;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    transition: box-shadow 0.2s, border-color 0.2s;
  }

  .event-card:hover {
    border-color: var(--brand-primary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .event-card--featured {
    background: linear-gradient(135deg, color-mix(in oklab, var(--brand-primary) 5%, white) 0%, #fff 100%);
    border-color: color-mix(in oklab, var(--brand-primary) 30%, transparent);
  }

  .event-card__date {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 64px;
    height: 64px;
    background: var(--brand-primary);
    color: #fff;
    border-radius: 8px;
    flex-shrink: 0;
  }

  .event-card__month {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .event-card__day {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
  }

  .event-card__content {
    flex: 1;
    min-width: 0;
  }

  .event-card__title {
    margin: 0 0 0.5rem;
    font-size: 1.25rem;
    line-height: 1.3;
  }

  .event-card__title a {
    color: var(--text-strong);
    text-decoration: none;
  }

  .event-card__title a:hover {
    color: var(--brand-primary);
  }

  .event-card__datetime {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin: 0 0 0.5rem;
  }

  .event-card__location {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.875rem;
    color: var(--text-muted);
    margin: 0 0 0.75rem;
  }

  .event-card__location svg {
    flex-shrink: 0;
  }

  .event-card__badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    background: color-mix(in oklab, var(--brand-primary) 15%, white);
    color: var(--brand-primary);
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.25rem;
  }

  .event-card__desc {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin: 0 0 1rem;
    line-height: 1.5;
  }

  .event-card__link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--brand-primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .event-card__link:hover {
    text-decoration: underline;
  }

  .event-card__link svg {
    transition: transform 0.2s;
  }

  .event-card__link:hover svg {
    transform: translateX(4px);
  }

  @media (max-width: 600px) {
    .event-card {
      flex-direction: column;
      gap: 1rem;
    }

    .event-card__date {
      flex-direction: row;
      gap: 0.5rem;
      width: fit-content;
      height: auto;
      padding: 0.5rem 1rem;
    }

    .event-card__month {
      font-size: 0.8rem;
    }

    .event-card__day {
      font-size: 1.25rem;
    }
  }
</style>
