---
import LanguageSwitcher from "./LanguageSwitcher.astro";
import type { Locale } from "../../utils/localization";

interface Props {
  currentPath: string;
  alternate?: { en: string; fr: string };
  locale?: Locale;
}

const props = Astro.props as Props;
const currentPath = props.currentPath ?? Astro.url.pathname;
const alternate = props.alternate;
const locale: Locale = props.locale ?? (currentPath.startsWith("/fr/") ? "fr" : "en");
const isFr = locale === "fr";

type NavConfig = {
  label: Record<Locale, string>;
  href: Record<Locale, string>;
  dropdown?: Array<{
    label: Record<Locale, string>;
    href: Record<Locale, string>;
    external?: boolean;
  }>;
  external?: boolean;
};

const navConfig: NavConfig[] = [
  {
    label: { en: "Announcements", fr: "Communiques" },
    href: { en: "/news/", fr: "/fr/nouvelles/" },
  },
  {
    label: { en: "About Us", fr: "A propos" },
    href: { en: "/about/", fr: "/fr/a-propos/" },
    dropdown: [
      {
        label: { en: "Mission & Values", fr: "Mission et valeurs" },
        href: { en: "/about/#mission", fr: "/fr/a-propos/#mission" },
      },
      {
        label: { en: "Meet the Board", fr: "Conseil d'administration" },
        href: { en: "/about/#board", fr: "/fr/a-propos/#board" },
      },
      {
        label: { en: "Meet the Staff", fr: "Equipe" },
        href: { en: "/about/#staff", fr: "/fr/a-propos/#staff" },
      },
      {
        label: { en: "Our Teams", fr: "Nos equipes" },
        href: { en: "/about/#teams", fr: "/fr/a-propos/#teams" },
      },
      {
        label: { en: "What is Quadball?", fr: "Qu'est-ce que le quadball?" },
        href: { en: "/about/#what-is-quadball", fr: "/fr/a-propos/#what-is-quadball" },
      },
    ],
  },
  {
    label: { en: "Contact Us", fr: "Nous joindre" },
    href: { en: "/contact/", fr: "/fr/contact/" },
  },
  {
    label: { en: "Events", fr: "Evenements" },
    href: { en: "/events/", fr: "/fr/evenements/" },
    dropdown: [
      {
        label: { en: "Upcoming Events", fr: "Evenements a venir" },
        href: { en: "/events/", fr: "/fr/evenements/" },
      },
      {
        label: { en: "Host an Event", fr: "Organiser un evenement" },
        href: { en: "/get-involved/#host-an-event", fr: "/fr/simpliquer/#host-an-event" },
      },
    ],
  },
  {
    label: { en: "Get Involved", fr: "S'impliquer" },
    href: { en: "/get-involved/", fr: "/fr/simpliquer/" },
    dropdown: [
      {
        label: { en: "Find a Team", fr: "Trouver une equipe" },
        href: { en: "/teams/", fr: "/fr/equipes/" },
      },
      {
        label: { en: "Volunteer Opportunities", fr: "Benevolat" },
        href: { en: "/get-involved/#volunteer", fr: "/fr/simpliquer/#volunteer" },
      },
      {
        label: { en: "Host an Event", fr: "Organiser un evenement" },
        href: { en: "/get-involved/#host-an-event", fr: "/fr/simpliquer/#host-an-event" },
      },
    ],
  },
];

const navItems = navConfig.map((item) => ({
  label: item.label[locale],
  href: item.href[locale],
  external: item.external,
  dropdown: item.dropdown?.map((child) => ({
    label: child.label[locale],
    href: child.href[locale],
    external: child.external,
  })),
}));

// Split nav items for desktop centered layout
const leftNavItems = navItems.slice(0, Math.ceil(navItems.length / 2));
const rightNavItems = navItems.slice(Math.ceil(navItems.length / 2));

function isActive(href: string) {
  if (!currentPath) return false;
  const normalized = href.endsWith("/") ? href : `${href}/`;
  const current = currentPath.endsWith("/") ? currentPath : `${currentPath}/`;
  return current === normalized || current.startsWith(normalized);
}

const ctaCopy = {
  contact: isFr ? "Nous joindre" : "Contact",
  store: isFr ? "Boutique" : "Store",
  donate: isFr ? "Faire un don" : "Donate",
};

const ctaLinks = {
  contact: isFr ? "/fr/contact/" : "/contact/",
  store: "https://www.vcultimate.com/",
  donate: "https://www.paypal.me/quidditchcanada",
};
---
<header class="site-header">
  <div class="site-header__bar">
    <!-- Mobile menu drawer -->
    <details class="drawer">
      <summary class="nav-toggle">
        <span class="nav-toggle__icon">
          <span></span>
          <span></span>
          <span></span>
        </span>
        <span class="sr-only">Menu</span>
      </summary>
      <nav id="site-nav-mobile" class="drawer__panel" aria-label={isFr ? "Navigation principale" : "Primary"}>
        {navItems.map((item) => (
          <a href={item.href} aria-current={isActive(item.href) ? "page" : undefined}>{item.label}</a>
        ))}
        <div class="drawer__actions">
          <a class="btn btn--secondary" href={ctaLinks.store} target="_blank" rel="noopener">{ctaCopy.store}</a>
          <a class="btn btn--primary" href={ctaLinks.donate} target="_blank" rel="noopener">{ctaCopy.donate}</a>
        </div>
        <div class="drawer__lang">
          <LanguageSwitcher currentPath={currentPath} alternate={alternate} />
        </div>
      </nav>
    </details>

    <!-- Desktop left controls -->
    <div class="site-header__side site-header__side--left">
      <div class="site-header__lang">
        <LanguageSwitcher currentPath={currentPath} alternate={alternate} />
      </div>
      <nav class="site-header__nav site-header__nav--left" aria-label="Primary left">
        {leftNavItems.map((item) => (
          item.dropdown ? (
            <div class="nav-dropdown">
              <a href={item.href} aria-current={isActive(item.href) ? "page" : undefined} class="nav-dropdown__trigger">
                {item.label}
                <svg width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
                  <path d="M6 8L2 4h8z" fill="currentColor" />
                </svg>
              </a>
              <div class="nav-dropdown__menu">
                {item.dropdown.map((subItem) => (
                  <a href={subItem.href} target={subItem.external ? "_blank" : undefined} rel={subItem.external ? "noopener" : undefined}>
                    {subItem.label}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            <a href={item.href} aria-current={isActive(item.href) ? "page" : undefined}>{item.label}</a>
          )
        ))}
      </nav>
    </div>

    <!-- Centered logo -->
    <a class="site-header__title" href={isFr ? "/fr/" : "/"} aria-label={isFr ? "Quadball Canada — Accueil" : "Quadball Canada — Home"}>
      <img src="/quadball-canada-logo.jpg" alt="Quadball Canada" class="logo" />
    </a>

    <!-- Desktop right nav -->
    <nav class="site-header__nav site-header__nav--right" aria-label={isFr ? "Navigation principale droite" : "Primary right"}>
      {rightNavItems.map((item) => (
        item.dropdown ? (
          <div class="nav-dropdown">
            <a href={item.href} aria-current={isActive(item.href) ? "page" : undefined} class="nav-dropdown__trigger">
              {item.label}
              <svg width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
                <path d="M6 8L2 4h8z" fill="currentColor" />
              </svg>
            </a>
            <div class="nav-dropdown__menu">
              {item.dropdown.map((subItem) => (
                <a href={subItem.href} target={subItem.external ? "_blank" : undefined} rel={subItem.external ? "noopener" : undefined}>
                  {subItem.label}
                </a>
              ))}
            </div>
          </div>
        ) : (
          <a href={item.href} aria-current={isActive(item.href) ? "page" : undefined}>{item.label}</a>
        )
      ))}
      <a class="btn btn--secondary" href={ctaLinks.contact}>{ctaCopy.contact}</a>
      <a class="btn btn--secondary" href={ctaLinks.store} target="_blank" rel="noopener">{ctaCopy.store}</a>
      <a class="btn btn--primary" href={ctaLinks.donate} target="_blank" rel="noopener">{ctaCopy.donate}</a>
    </nav>
  </div>
</header>

<style>
  .site-header {
    position: relative;
    width: 100%;
    backdrop-filter: saturate(140%) blur(8px);
    background: color-mix(in oklab, var(--bg) 85%, white 15%);
    border-bottom: 1px solid var(--border);
  }

  .site-header__bar {
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
    align-items: center;
    gap: 24px;
    box-sizing: border-box;
    width: 100%;
    padding: 8px clamp(16px, 4vw, 40px);
  }

  .site-header__side {
    display: flex;
    align-items: center;
    gap: 16px;
    width: 100%;
  }

  .site-header__side--left {
    justify-self: stretch;
  }

  .site-header__lang {
    flex-shrink: 0;
  }

  .site-header__title {
    display: inline-flex;
    align-items: center;
    justify-self: center;
    text-decoration: none;
  }

  .logo {
    height: 60px;
    width: auto;
    display: block;
  }

  .site-header__nav {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-shrink: 0;
  }

  .site-header__nav--left {
    justify-content: flex-end;
    margin-left: auto;
  }

  .site-header__nav--right {
    justify-content: flex-start;
  }

  .site-header__nav a {
    color: var(--text-strong);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
    white-space: nowrap;
    transition: color 0.2s ease;
  }

  .site-header__nav a:hover {
    color: var(--brand-primary);
  }

  .site-header__nav a[aria-current="page"] {
    color: var(--brand-primary);
  }

  .btn {
    display: inline-block;
    padding: 0.6rem 1.1rem;
    border-radius: 8px;
    text-decoration: none !important;
    font-weight: 700;
    white-space: nowrap;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .btn--primary {
    background: var(--brand-primary);
    color: #fff !important;
    box-shadow: 0 1px 3px rgba(0,0,0,.12);
  }

  .btn--primary:hover {
    background: var(--brand-ink);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,.16);
  }

  .btn--secondary {
    background: #fff;
    border: 1px solid var(--border);
    color: var(--text-strong) !important;
  }

  .btn--secondary:hover {
    border-color: var(--brand-primary);
    color: var(--brand-primary) !important;
  }

  /* Mobile drawer */
  .drawer {
    display: none;
  }

  .nav-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    list-style: none;
  }

  .nav-toggle::-webkit-details-marker {
    display: none;
  }

  .nav-toggle__icon {
    display: flex;
    flex-direction: column;
    gap: 3px;
    width: 18px;
  }

  .nav-toggle__icon span {
    height: 2px;
    background: var(--text-strong);
    border-radius: 1px;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  .drawer[open] .nav-toggle__icon span:nth-child(1) {
    transform: translateY(5px) rotate(45deg);
  }

  .drawer[open] .nav-toggle__icon span:nth-child(2) {
    opacity: 0;
  }

  .drawer[open] .nav-toggle__icon span:nth-child(3) {
    transform: translateY(-5px) rotate(-45deg);
  }

  .drawer__panel {
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    padding: 20px;
    background: #fff;
    border-bottom: 1px solid var(--border);
    box-shadow: 0 4px 12px rgba(0,0,0,.08);
  }

  .drawer__panel a {
    display: block;
    padding: 12px 0;
    color: var(--text-strong);
    text-decoration: none;
    font-weight: 600;
    border-bottom: 1px solid var(--border);
  }

  .drawer__panel a:hover {
    color: var(--brand-primary);
  }

  .drawer__panel a[aria-current="page"] {
    color: var(--brand-primary);
  }

  .drawer__actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .drawer__actions .btn {
    flex: 1;
    text-align: center;
  }

  .drawer__lang {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
  }

  /* Dropdown menu */
  .nav-dropdown {
    position: relative;
    display: inline-block;
  }

  .nav-dropdown__trigger {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }

  .nav-dropdown__trigger svg {
    transition: transform 0.2s ease;
  }

  .nav-dropdown:hover .nav-dropdown__trigger svg {
    transform: rotate(180deg);
  }

  .nav-dropdown__menu {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 8px;
    min-width: 200px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
    z-index: 50;
  }

  .nav-dropdown:hover .nav-dropdown__menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .nav-dropdown__menu a {
    display: block;
    padding: 12px 16px;
    color: var(--text-strong);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s ease, color 0.15s ease;
  }

  .nav-dropdown__menu a:last-child {
    border-bottom: none;
  }

  .nav-dropdown__menu a:hover {
    background: var(--brand-tint);
    color: var(--brand-primary);
  }

  @media (max-width: 1024px) {
    .site-header__bar {
      grid-template-columns: auto 1fr;
    }

    .site-header__side,
    .site-header__nav--left,
    .site-header__nav--right {
      display: none;
    }

    .drawer {
      display: block;
      justify-self: start;
    }

    .site-header__title {
      justify-self: center;
      margin-right: 40px; /* Balance against menu button */
    }
  }

  @media (max-width: 480px) {
    .logo {
      height: 36px;
    }
  }
</style>
